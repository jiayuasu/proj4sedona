name: PR Checks

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up JDK 11
      uses: actions/setup-java@v5
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'maven'

    - name: Validate Maven POMs
      run: mvn validate -B

    - name: Check for merge conflicts
      run: |
        if git grep -l '<<<<<<< HEAD' -- '*.java' '*.xml' '*.md'; then
          echo "Found merge conflict markers"
          exit 1
        fi

    - name: Build and test all modules
      run: mvn clean install -B

    - name: Verify package builds
      run: mvn package -DskipTests -B

  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Check PR size
      uses: actions/github-script@v8
      with:
        script: |
          const pr = context.payload.pull_request;
          const additions = pr.additions;
          const deletions = pr.deletions;
          const total = additions + deletions;
          
          console.log(`PR changes: +${additions} -${deletions} (${total} total)`);
          
          if (total > 1000) {
            core.warning(`This PR is quite large (${total} lines changed). Consider breaking it into smaller PRs.`);
          }

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 11
      uses: actions/setup-java@v5
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'maven'

    - name: Run dependency check
      run: mvn verify -DskipTests -B

    - name: Check for vulnerable dependencies
      continue-on-error: true
      run: |
        mvn dependency:tree -B
        mvn versions:display-dependency-updates -B

  compatibility:
    name: Backward Compatibility Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up JDK 11
      uses: actions/setup-java@v5
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build current version
      run: mvn clean install -DskipTests -B

    - name: Check API compatibility
      continue-on-error: true
      run: |
        echo "API compatibility check completed"
        # Could add japicmp or similar tool here

  comment-summary:
    name: Comment Test Summary
    runs-on: ubuntu-latest
    needs: [validate]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Download test results
      uses: actions/download-artifact@v7
      continue-on-error: true
      with:
        name: test-results-java-11
        path: test-results/

    - name: Comment PR with summary
      uses: actions/github-script@v8
      with:
        script: |
          const fs = require('fs');
          const status = '${{ needs.validate.result }}';
          const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
          
          const body = `## ${emoji} PR Check Summary
          
          **Status**: ${status}
          
          ### Build & Test Results
          - Maven Build: ${status === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}
          - Unit Tests: ${status === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}
          
          ${status === 'success' ? 'üéâ All checks passed! Ready for review.' : '‚ö†Ô∏è Some checks failed. Please review the logs.'}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

